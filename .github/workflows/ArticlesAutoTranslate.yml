name: Articles Auto Translate
run-name: ${{ github.event.label.name }} - ${{ github.event.issue.title }}

on:
  issues:
    types: [labeled]

jobs:
  auto-translate:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write

    steps:
      ### ğŸŸ¢ é˜Ÿåˆ—é”ï¼šé˜²æ­¢å¹¶å‘å†²çª
      - uses: softprops/turnstyle@v1
        with:
          poll-interval-seconds: 10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      ### âœ… æ£€æŸ¥ issue body
      - name: Validate issue body
        if: ${{ !github.event.issue.body }}
        run: |
          echo "âŒ Issue body is empty. Exiting."
          exit 1

      ### âœ… æå–è¯­è¨€ä»£ç 
      - name: Extract language code
        id: lang
        run: |
          title="${{ github.event.issue.title }}"
          LANG_CODE=$(echo "$title" | sed -E 's/^\[([a-zA-Z]+)\].*/\1/')
          echo "lang=$LANG_CODE" >> $GITHUB_OUTPUT
          echo "LANG_CODE=$LANG_CODE" >> $GITHUB_ENV

      ### âœ… Checkout repository
      - uses: actions/checkout@v4

      ### âœ… é…ç½® Git
      - name: Setup Git
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git config pull.rebase true

      ### ğŸ“ çˆ¬å–æ–‡ç« å¹¶ç”Ÿæˆ Markdown
      - name: Fetch article and convert to Markdown
        id: fetch
        uses: freecodecamp/article-webpage-to-markdown-action@dev
        with:
          newsLink: "${{ github.event.issue.body }}"
          includeSelector: 'span.author-card-name,section.post-content'
          ignoreSelector: '.ad-wrapper'
          skipSameArticleCheck: true
          skipIssueComment: true
          markDownFilePath: './articles/_tmp/'
          githubToken: "${{ github.token }}"

      ### ğŸ›¡ å¤‡ä»½çˆ¬å–çš„ Markdown åˆ°å¤–éƒ¨å®‰å…¨è·¯å¾„ï¼ˆä¿æŒåŸå§‹æ–‡ä»¶åï¼‰
      - name: Backup fetched Markdown to /tmp
        id: backup-md
        run: |
          original_file="${{ steps.fetch.outputs.markdown_file_path }}"
          filename=$(basename "$original_file")
          BACKUP_PATH="/tmp/$filename"
          cp "$original_file" "$BACKUP_PATH"
          echo "path=$BACKUP_PATH" >> $GITHUB_OUTPUT
          echo "BACKUP_PATH=$BACKUP_PATH" >> $GITHUB_ENV
          echo "âœ… Markdown backed up to $BACKUP_PATH"

      ### âœ… ä¿å­˜è‹±æ–‡åŸæ–‡å¹¶æäº¤åˆ° main åˆ†æ”¯
      - name: Commit raw article to main
        run: |
          file="${{ steps.fetch.outputs.markdown_file_path }}"
          base=$(basename "$file")
          lang="${{ steps.lang.outputs.lang }}"

          mkdir -p "./articles/_raw/"
          cp "$file" "./articles/_raw/$base"
          [ -f "./articles/$lang/$base" ] || cp "$file" "./articles/$lang/$base"

          git add -f "./articles/_raw/$base" "./articles/$lang/$base" || true
          git commit -m "Add raw article: $base" || echo "â„¹ï¸ Nothing to commit."

          git fetch origin main
          git stash push -u -m "Auto-stash before rebase" || true
          git pull --rebase origin main || true
          git stash pop || true

          for i in {1..3}; do
            git push origin main && break
            echo "âš ï¸ Push failed. Retrying in 5s..."
            sleep 5
            git pull --rebase origin main || true
          done

      ### âœ… åˆ‡æ¢åˆ° auto-translate åˆ†æ”¯ï¼ˆè§£å†³å†²çª & æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼‰
      - name: Checkout auto-translate branch
        run: |
          # ğŸ›¡ æ£€æŸ¥ merge pending çŠ¶æ€
          if [ -f ".git/MERGE_HEAD" ]; then
            echo "âš ï¸ Unfinished merge detected. Aborting..."
            git merge --abort || git reset --merge
          fi

          # ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶é˜²æ­¢æ±¡æŸ“åˆ†æ”¯
          rm -rf ./articles/_tmp/

          git fetch origin
          git checkout -B auto-translate origin/auto-translate

          git merge --strategy=recursive --strategy-option=theirs main || true

      ### ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡ç« ï¼ˆä½¿ç”¨å®‰å…¨è·¯å¾„ï¼‰
      - name: Translate article
        uses: miyaliu666/articles-auto-translate-action@main
        with:
          with_issue_title: "${{ github.event.issue.title }}"
          with_issue_body: "${{ github.event.issue.body }}"
          with_label_name: "${{ github.event.label.name }}"
          with_github_token: "${{ github.token }}"
          with_orginal_markdown_file_path: "${{ steps.backup-md.outputs.path }}"
          with_task_fetch_to_save_path: "./articles/_raw/"
          with_task_translate_openai_api_key: "${{ secrets.OPENAI_API_KEY }}"
          with_task_translate_to_save_path: "./articles/{lang}/"

      ### âœ… æäº¤ç¿»è¯‘åçš„æ–‡ä»¶
      - name: Commit translated article
        run: |
          base=$(basename "$BACKUP_PATH")
          lang="${{ env.LANG_CODE }}"
          translated="./articles/$lang/$base"

          [ -f "$translated" ] || { echo "âŒ Translated file missing."; exit 1; }

          git add "$translated"
          git commit -m "Add translated article: $base" || echo "â„¹ï¸ Nothing to commit."

          git fetch origin auto-translate

          # ğŸ›¡ å®‰å…¨ rebaseï¼Œè§£å†³å†²çª
          git stash push -u -m "Auto-stash before rebase" || true
          if [ -f ".git/MERGE_HEAD" ]; then
            echo "âš ï¸ Unfinished merge detected. Aborting..."
            git merge --abort || git reset --merge
          fi
          git pull --rebase origin auto-translate || true
          git stash pop || true

          for i in {1..3}; do
            git push origin auto-translate && break
            echo "âš ï¸ Push failed. Retrying in 5s..."
            sleep 5
            git pull --rebase origin auto-translate || true
          done

      ### ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: Cleanup temp directory
        run: |
          rm -rf ./articles/_tmp/
          git add -u ./articles/_tmp/ || true
          git commit -m "Cleanup _tmp directory" || echo "â„¹ï¸ Nothing to commit."

          git fetch origin main
          git stash push -u -m "Auto-stash before rebase" || true
          git pull --rebase origin main || true
          git stash pop || true

          for i in {1..3}; do
            git push origin main && break
            echo "âš ï¸ Push failed. Retrying in 5s..."
            sleep 5
            git pull --rebase origin main || true
          done
